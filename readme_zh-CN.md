# utf8-ctc
标准电码，但使用UTF8作为回退编码。

[English](./README.md)

## 什么是标准电码？为什么都20XX年了还要用它？

标准电码原本是用于在电报中传送中文信息的一种编码。它将常用字列表并指派唯一的四字编码。
例如`汉`字，它的编码是`3352`。它提供了一种更紧凑的编码中文的方式：
标准电码只需要2字节（实际取值为0000到9999），而UTF-8则平均使用3字节。

一般来说，UTF-8 是处理所有类型字符的最佳选择，但在讨论长度受限的编码时，标准电码就变得非常有用。

## 这个程序是做什么的？

这个程序是为明信片上的文本编码而编写的。而我们并不想使用base58来表示加密数据，但又希望获得一定程度的隐私。
因此，该程序将中文编码为标准电码，如果有字符缺失，则使用原始UTF-8编码或压缩UTF-8编码。

> 手写和输入数字要比base64或base58字符串简单得多。

程序是这样设计的：当书写明信片时，我通过命令行选项、文件或标准输入流将文字编码，这个程序将输出对应的
电码数字，我只需要将这些数字抄写到明信片上。

当其他人收到明信片后，他可以将这些数字原封不动的敲入程序，然后程序就会显示出解码的文字。

## 使用

这个程序使用jlink构建，搭配zulu 21 jdk，所以从技术上来说，你不需要在电脑上额外安装Java运行环境
就可以使用本程序。
前往发布页面，下载对应的构建版本，然后调用`./ctc`应该就万事大吉了。

> 目前还没有可用于作为依赖的发布。这个程序不是作为依赖编写的，我也没有将其作为依赖测试，因此
> 我不想让别人无意间将其作为依赖使用并造成灾难。你可以尝试使用jitpack，但我无法向你保证结果。
> 
> ***如果呼声很高的话，请创建一个Issue，我会将其作为一个依赖发布的。***

### 编码

你可以使用命令行选项、文件和标准输入流进行编码：

```bash
./ctc encode -t "天匠染青红，花腰呈袅娜。"
./ctc encode -f message.txt
echo "天匠染青红，花腰呈袅娜。" | ./ctc encode -c UTF-8
```

当`-t`和`-f`选项同时出现时，`-t <text>`会覆盖`-f <file>`。
当你使用标准输入流时，除非关闭输入流，否则你需要手动告诉程序你写完了。在新的一行中输入`EOF`然后回车即可。

你也可以使用`--eof=EOT`选项来修改这个标志。这样你就可以使用`EOT`来代替`EOF`了。

你还可以修改每行打印多少个电码。但请务必知悉，这最终会受限于你终端的宽度。
默认情况下每行打印5个电码，你可以通过`-w 6`来设置为每行6个。

当使用标准输入流时，在Windows系统上会有字符集的问题。
默认情况下程序使用UTF-8字符集进行输入输出。
但在Windows上，程序将在默认地区设置为`zh-CN`时使用`GBK`字符集；
或者在默认地区设置为`zh-TW`时使用`BIG5`字符集。
如果你不想要这个功能，你可以使用`-c UTF-8`来强制程序使用UTF-8字符集。

> 虽然程序支持台湾的BIG5字符集，但标准电码使用的是大陆的版本，因此所有字符将会被当成UTF-8编码。

请务必先验证程序的输出，再将数字抄写到明信片上。
有时如果你不仔细检查的话，字符集的问题会无意中打你个措手不及。

### 解码

解码和编码差不多，但是更简单。
解码时程序只用UTF-8，这在包括Windows在内的系统上的大多数终端都可以正常工作。

解码时有三个命令行选项：`-t`、`-f`和`--eof`。

你可以输入任何字符，程序将会忽略他们并且只留下0到9的数字。所以如果你不小心输入了字母或其他东西，
不用担心，继续敲就好了。

```bash
./ctc decode -t "1131, 0561, 2676, 7230, 4767, 9976, 5363, 5212, 0701, 5934, 1226, 9975"
```

### 加密

从v0.1.0版本开始，我增加了一个基于VMPC随机数生成器的置换加密。
它支持对称加密（只提供`-k string`选项），还支持非对称加密（同时提供`-k string`和`--dh hex`）来
使用X25519椭圆密钥交换算法。

当使用对称加密时，`-k key`中的密钥key将会被UTF-8编码，并进行SHA3-256运算。
运算结果将作为VMPC随机数生成器的种子。

当使用非对称加密时，`-k key`中的密钥key将会被UTF-8编码，并进行SHA3-256运算。
运算结果将作为我们的私钥进行X25519运算。运算结果将被SHA3-256哈希，结果作为VMPC随机数生成器的种子。

使用`./ctc pubkey key`命令来查看当密钥为`key`时的公钥。

加密是基于置换加密的。实现位于[Utils.kt](./src/main/kotlin/info/skyblond/ctc/Utils.kt)
文件中的`#randomize`函数和`#derandomize`函数。 

一次随机打乱数据是不够安全的，所以你可以通过`-n`选项来决定进行多少次随机轮换。
默认情况下它进行120万次运算。

## 内部设计

### 预处理

本程序在简单的查表和替换之上还有更复杂的预处理。
标准电码取自：https://en.wiktionary.org/wiki/Appendix:Chinese_telegraph_code/Mainland_1983

在开始编码之前，我们需要进行如下替换来获得更简短的编码：
+ 换行（`\n`）将被替换为`〷`（电码9999）
+ 类似`10日`的词将被替换为`㏩`（电码9910）

这些操作将会减少一些电码，并且这种变换对用户是透明的。
在解码时将会应用它的逆变换来确保解码出来的问题是正确的。

### UTF-8回退编码

当遇到标准电码中没有的字符时，程序将其存储在一个缓冲区中，并按批处理。
例如编码`大家好，my name is XXX。`时，未知缓冲区将是`my name is XXX`。
随后缓冲区内的数据将会按照UTF-8编码。编码后将会被`java.util.zip.Deflater`以最大等级压缩，
如果压缩后的长度小于原始长度，则使用压缩后的编码。

对于原始UTF-8编码，它将被包括在电码`9992`和`9993`之间。内容则是以0000到9991来表示。
表示的方法类似base9992但以纯数字形式表现。

对于压缩的UTF-8编码，它将被包括在电码`9994`和`9995`之间。内容的表示方法相同。

## 贡献

欢迎任何贡献，但我无法保证你的PR会被接受。
如果有任何问题，可以创建一个Issue，但我无法保证一定会解答你的问题。

太长不看：我对于这个程序不给出任何保证，除非你付给我钱。
